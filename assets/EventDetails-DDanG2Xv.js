import{a as b,r as l,j as e,R as w,b as S,S as C,L as T}from"./index-DLXa8zyf.js";import{e as E}from"./events.service-r7Bkl8Fg.js";import{L as v}from"./Layout-Co0fdUwk.js";import{f as U}from"./index-CmJUnWuT.js";import{t as D}from"./tasks.service-B7s00J5g.js";const L={getAll:async()=>{const{data:t}=await b.get("/departments");return t},getOne:async t=>{const{data:a}=await b.get(`/departments/${t}`);return a},create:async t=>{const{data:a}=await b.post("/departments",{name:t});return a}},V={create:async t=>{const{data:a}=await b.post("/assignments",t);return a},getByTask:async t=>{const{data:a}=await b.get(`/assignments/task/${t}`);return a},delete:async t=>{await b.delete(`/assignments/${t}`)}},A={getAll:async()=>{const{data:t}=await b.get("/auth/users");return t},getUsers:async()=>{try{const{data:t}=await b.get("/users");return t}catch{return[]}}},B=({eventId:t,onUploadSuccess:a})=>{const[u,f]=l.useState(null),[i,p]=l.useState(!1),[y,x]=l.useState(null),[d,m]=l.useState([]),c=l.useRef(null),h=r=>{if(r.target.files&&r.target.files[0]){const o=r.target.files[0];if(!o.name.endsWith(".csv")){x("Please select a valid CSV file"),f(null);return}f(o),x(null),m([])}},j=async()=>{var r,o,N,s;if(u){p(!0),x(null),m([]);try{await D.uploadCSV(t,u),f(null),c.current&&(c.current.value=""),a()}catch(n){const g=n;((o=(r=g.response)==null?void 0:r.data)==null?void 0:o.message)==="CSV validation failed"?m(g.response.data.errors||[]):x(((s=(N=g.response)==null?void 0:N.data)==null?void 0:s.message)||"Failed to upload CSV. Please check the file format.")}finally{p(!1)}}};return e.jsxs("div",{className:"bg-white p-6 rounded-xl border-2 border-dashed border-gray-300",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",stroke:"currentColor",fill:"none",viewBox:"0 0 48 48","aria-hidden":"true",children:e.jsx("path",{d:"M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"})}),e.jsxs("div",{className:"mt-4 flex text-sm text-gray-600 justify-center",children:[e.jsxs("label",{htmlFor:"file-upload",className:"relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500",children:[e.jsx("span",{children:"Upload a CSV file"}),e.jsx("input",{id:"file-upload",name:"file-upload",type:"file",className:"sr-only",accept:".csv",onChange:h,ref:c})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-gray-500",children:"BOQ CSV with S.no, Task, Description, Name, Department"})]}),u&&e.jsxs("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-blue-700 truncate",children:u.name}),e.jsx("button",{onClick:j,disabled:i,className:"bg-blue-600 text-white px-4 py-1 rounded text-sm font-bold hover:bg-blue-700 disabled:bg-blue-300 transition",children:i?"Uploading...":"Upload Now"})]}),y&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 text-red-700 rounded-lg text-sm border border-red-100",children:y}),d.length>0&&e.jsxs("div",{className:"mt-4 p-4 bg-red-50 text-red-800 rounded-lg border border-red-200",children:[e.jsx("p",{className:"font-bold text-sm mb-2 text-red-900",children:"Validation Errors:"}),e.jsxs("ul",{className:"list-disc list-inside text-xs space-y-1",children:[d.slice(0,10).map((r,o)=>e.jsx("li",{children:r},o)),d.length>10&&e.jsxs("li",{className:"font-bold underline",children:["...and ",d.length-10," more errors"]})]})]})]})},M=({tasks:t,users:a,departments:u,onRefresh:f})=>{const[i,p]=l.useState([]),[y,x]=l.useState(!1),[d,m]=l.useState(""),[c,h]=l.useState("department"),[j,r]=l.useState(!1),o=s=>{p(n=>n.includes(s)?n.filter(g=>g!==s):[...n,s])},N=async()=>{if(!(!d||i.length===0)){r(!0);try{await Promise.all(i.map(s=>V.create({taskId:s,userId:c==="user"?d:void 0,departmentId:c==="department"?d:void 0}))),p([]),x(!1),f()}catch{alert("Failed to assign tasks")}finally{r(!1)}}};return e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"mb-4 flex justify-between items-center",children:[e.jsxs("span",{className:"text-sm text-gray-600 font-medium",children:[i.length," tasks selected"]}),e.jsx("button",{onClick:()=>x(!0),disabled:i.length===0,className:"bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 disabled:bg-gray-300 transition",children:"Assign Selected Tasks"})]}),e.jsx("div",{className:"overflow-x-auto border rounded-xl shadow-sm bg-white",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:e.jsx("input",{type:"checkbox",onChange:s=>{s.target.checked?p(t.map(n=>n.id)):p([])},checked:i.length===t.length&&t.length>0,className:"rounded text-blue-600 outline-none"})}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase",children:"S.No"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase",children:"Task"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase",children:"Department"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase",children:"Assigned To"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:t.map(s=>e.jsxs("tr",{className:"hover:bg-blue-50 transition",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx("input",{type:"checkbox",checked:i.includes(s.id),onChange:()=>o(s.id),className:"rounded text-blue-600 outline-none"})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:s.sNo}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("p",{className:"text-sm font-bold text-gray-900",children:s.taskName}),e.jsx("p",{className:"text-xs text-gray-500 truncate max-w-xs",children:s.description})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-700",children:s.departmentName})}),e.jsx("td",{className:"px-4 py-3 text-sm",children:s.assignments&&s.assignments.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:s.assignments.map(n=>{var g,k;return e.jsx("span",{className:"bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold",children:((g=n.user)==null?void 0:g.name)||((k=n.department)==null?void 0:k.name)},n.id)})}):e.jsx("span",{className:"text-gray-400 italic",children:"Unassigned"})})]},s.id))})]})}),y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-900 mb-6 font-display",children:["Assign ",i.length," Tasks"]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Assign to Type"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",className:"text-blue-600",checked:c==="department",onChange:()=>{h("department"),m("")}}),e.jsx("span",{className:"ml-2 text-sm",children:"Department"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",className:"text-blue-600",checked:c==="user",onChange:()=>{h("user"),m("")}}),e.jsx("span",{className:"ml-2 text-sm",children:"Specific User"})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:["Select ",c==="department"?"Department":"User"]}),e.jsxs("select",{value:d,onChange:s=>m(s.target.value),className:"w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none",children:[e.jsx("option",{value:"",children:"Select an option"}),c==="department"?u.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id)):a.filter(s=>s.role==="DEPARTMENT_USER").map(s=>{var n;return e.jsxs("option",{value:s.id,children:[s.name," (",(n=s.department)==null?void 0:n.name,")"]},s.id)})]})]}),e.jsxs("div",{className:"flex space-x-3 pt-4",children:[e.jsx("button",{onClick:()=>x(!1),className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-bold hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:N,disabled:!d||j,className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 disabled:bg-blue-300 shadow-lg shadow-blue-200",children:j?"Assigning...":"Confirm"})]})]})]})})]})},F=w.memo(M),O=()=>{var j;const{id:t}=S(),[a,u]=l.useState(null),[f,i]=l.useState([]),[p,y]=l.useState([]),[x,d]=l.useState(!0),[m,c]=l.useState(""),h=l.useCallback(async()=>{if(t)try{const[r,o,N]=await Promise.all([E.getOne(t),L.getAll(),A.getUsers()]);u(r),i(o),y(N)}catch{c("Failed to fetch event details")}finally{d(!1)}},[t]);return l.useEffect(()=>{h()},[h]),x?e.jsx(v,{children:e.jsx("div",{className:"h-96 flex items-center justify-center",children:e.jsx(C,{size:"lg"})})}):m||!a?e.jsx(v,{children:e.jsx("div",{className:"p-8 text-center text-red-600 font-bold bg-red-50 rounded-2xl border border-red-100",children:m||"Event not found"})}):e.jsx(v,{children:e.jsxs("div",{className:"flex flex-col space-y-6",children:[e.jsx("div",{className:"flex justify-between items-start",children:e.jsxs("div",{children:[e.jsxs("nav",{className:"flex text-xs font-bold text-gray-400 uppercase tracking-widest mb-2",children:[e.jsx(T,{to:"/admin/events",className:"hover:text-blue-600 transition-colors",children:"Events"}),e.jsx("span",{className:"mx-2 text-gray-300",children:"/"}),e.jsx("span",{className:"text-blue-600",children:a.name})]}),e.jsx("h1",{className:"text-4xl font-black text-gray-900 leading-tight",children:a.name}),e.jsxs("div",{className:"flex items-center text-gray-500 mt-2 font-medium",children:[e.jsx("svg",{className:"w-5 h-5 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),U(a.eventDate,{dateStyle:"long"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-8",children:[e.jsxs("div",{className:"space-y-6 lg:col-span-1",children:[e.jsxs("div",{className:"bg-white p-6 rounded-2xl shadow-sm border",children:[e.jsx("h2",{className:"text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-4",children:"Description"}),e.jsx("p",{className:"text-gray-700 text-sm leading-relaxed italic",children:a.description||"No description provided."})]}),e.jsxs("div",{className:"bg-white p-6 rounded-2xl shadow-sm border overflow-hidden",children:[e.jsx("h2",{className:"text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-4",children:"Upload BOQ"}),e.jsx(B,{eventId:a.id,onUploadSuccess:h})]})]}),e.jsx("div",{className:"lg:col-span-3",children:e.jsxs("div",{className:"bg-white p-8 rounded-2xl shadow-sm border min-h-[500px]",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8 pb-4 border-b border-gray-100",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-black text-gray-900 tracking-tight",children:"BOQ Worksheet"}),e.jsxs("p",{className:"text-gray-500 text-sm mt-1",children:["Found ",((j=a.tasks)==null?void 0:j.length)||0," tasks for this event."]})]}),e.jsx("button",{onClick:h,className:"p-2 border rounded-lg hover:bg-gray-50 transition-colors",children:e.jsx("svg",{className:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]}),a.tasks&&a.tasks.length>0?e.jsx(F,{tasks:a.tasks,users:p,departments:f,onRefresh:h}):e.jsxs("div",{className:"text-center py-32 border-2 border-dashed border-gray-100 rounded-3xl group",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-blue-50 transition-colors",children:e.jsx("svg",{className:"w-8 h-8 text-gray-300 group-hover:text-blue-500 transition-colors",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),e.jsx("p",{className:"text-gray-400 font-medium italic",children:"No tasks uploaded yet."}),e.jsx("p",{className:"text-gray-300 text-xs mt-1",children:"Upload a CSV file to begin assigning tasks."})]})]})})]})]})})};export{O as default};
